{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- HTMX for live updates -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
{% endblock %}

{% block content %}
<div class="dashboard">
    <header class="dashboard-header">
        <h1>Reddit Agent Dashboard</h1>
        <div class="header-actions">
            <a href="/admin/env" class="btn btn-primary">Settings</a>
            <a href="/admin/workflow" class="btn btn-primary">Workflow</a>
            <a href="/admin/logout" class="btn btn-secondary">Logout</a>
        </div>
    </header>

    <div class="stats-grid" hx-get="/admin/api/live-stats" hx-trigger="every 30s" hx-swap="outerHTML">
        <div class="stat-card">
            <h3>Pending Drafts</h3>
            <p class="stat-value">{{ stats.status_counts.PENDING }}</p>
        </div>

        <div class="stat-card">
            <h3>Today's Comments</h3>
            <p class="stat-value">{{ stats.daily_count.count }} / {{ stats.daily_count.limit }}</p>
            <p class="stat-label">{{ stats.daily_count.percentage }}% of daily limit</p>
        </div>

        <div class="stat-card">
            <h3>Approval Rate</h3>
            <p class="stat-value">{{ stats.performance.approval_rate }}%</p>
            <p class="stat-label">Last 7 days</p>
        </div>

        <div class="stat-card">
            <h3>Publish Rate</h3>
            <p class="stat-value">{{ stats.performance.publish_rate }}%</p>
            <p class="stat-label">Last 7 days</p>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: var(--space-md); margin-bottom: var(--space-xl);">
        <div class="card">
            <h2>Status Distribution</h2>
            <canvas id="statusPieChart" style="max-height: 300px;"></canvas>
        </div>

        <div class="card">
            <h2>7-Day Trend</h2>
            <canvas id="weeklyTrendChart" style="max-height: 300px;"></canvas>
        </div>
    </div>

    <div class="content-grid">
        <div class="card">
            <h2>Recent Drafts</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Subreddit</th>
                            <th>Status</th>
                            <th>Quality</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for draft in stats.recent_drafts %}
                        <tr>
                            <td>r/{{ draft.subreddit }}</td>
                            <td>
                                <span class="badge badge-{{ draft.status.lower() }}">
                                    {{ draft.status }}
                                </span>
                            </td>
                            <td>
                                {% if draft.quality_score %}
                                    {{ "%.2f"|format(draft.quality_score) }}
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>{{ draft.created_at }}</td>
                            <td>
                                {% if draft.status == 'PENDING' %}
                                <a href="{{ draft.context_url }}" target="_blank" class="btn-link">View</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="5" class="empty-state">No drafts yet</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h2>Subreddit Distribution</h2>
            <div class="distribution-list">
                {% for item in stats.subreddit_distribution %}
                <div class="distribution-item">
                    <span class="distribution-label">r/{{ item.subreddit }}</span>
                    <span class="distribution-bar">
                        <span class="distribution-fill" style="width: {{ (item.count / 10 * 100) if item.count <= 10 else 100 }}%"></span>
                    </span>
                    <span class="distribution-value">{{ item.count }}</span>
                </div>
                {% else %}
                <p class="empty-state">No data yet</p>
                {% endfor %}
            </div>
        </div>
    </div>

    <footer class="dashboard-footer">
        <p>Reddit Comment Engagement Agent v2.5 | Phase 3: Interactive Dashboard</p>
    </footer>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Chart.js initialization
document.addEventListener('DOMContentLoaded', function() {
    // Status Distribution Pie Chart
    const statusCtx = document.getElementById('statusPieChart');
    if (statusCtx) {
        new Chart(statusCtx, {
            type: 'doughnut',
            data: {
                labels: ['Pending', 'Approved', 'Published', 'Rejected'],
                datasets: [{
                    data: [
                        {{ stats.status_counts.PENDING }},
                        {{ stats.status_counts.APPROVED }},
                        {{ stats.status_counts.PUBLISHED }},
                        {{ stats.status_counts.REJECTED }}
                    ],
                    backgroundColor: [
                        '#fef3c7',  // Pending - warm yellow
                        '#d1fae5',  // Approved - green
                        '#dbeafe',  // Published - blue
                        '#fee2e2'   // Rejected - red
                    ],
                    borderColor: [
                        '#92400e',
                        '#065f46',
                        '#1e40af',
                        '#991b1b'
                    ],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    },
                    title: {
                        display: false
                    }
                }
            }
        });
    }

    // Weekly Trend Line Chart
    const trendCtx = document.getElementById('weeklyTrendChart');
    if (trendCtx) {
        const weeklyData = {{ stats.weekly_trend | tojson }};

        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: weeklyData.map(d => d.date),
                datasets: [{
                    label: 'Comments Published',
                    data: weeklyData.map(d => d.count),
                    borderColor: '#d97706',
                    backgroundColor: 'rgba(217, 119, 6, 0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
